import os
import logging
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ChatAction
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    CallbackQueryHandler,
    ConversationHandler,
)
from telegram.helpers import escape_markdown
import google.generativeai as genai
from dotenv import load_dotenv

# Firebase (optional, only if you have credentials)
import firebase_admin
from firebase_admin import credentials, firestore

# Load .env if you have one
# load_dotenv()

# --- Logging setup ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logging.getLogger("httpx").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# --- Configuration ---
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "8476487980:AAGA0KPOkDnTr5sKqN7VSDke7A7bW9xPHAE")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "AIzaSyAylJS6nqUEzCM1AUBjeYB68YVhLuLQeTg")
FIREBASE_CREDENTIALS_PATH = os.getenv("FIREBASE_CREDENTIALS_PATH")

if not TELEGRAM_BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN is not set!")
if not GEMINI_API_KEY:
    raise ValueError("GEMINI_API_KEY is not set!")

db = None
if FIREBASE_CREDENTIALS_PATH:
    try:
        cred = credentials.Certificate(FIREBASE_CREDENTIALS_PATH)
        firebase_admin.initialize_app(cred)
        db = firestore.client()
        logger.info("Firebase initialized successfully.")
    except Exception as e:
        logger.error(f"Firebase init failed: {e}")

# Configure Gemini API
genai.configure(api_key=GEMINI_API_KEY)

# --- Conversation States ---
PROBLEM, SYMPTOMS, AGE, GENDER, DURATION, VACCINE_AGE_GROUP = range(6)

# --- Localization messages ---
MESSAGES = {
    'en': {
        'welcome': "Welcome to Arogya Mitra! Please select your language:",
        'lang_chosen': "Language selected: English. Use /help for assistance.",
        'help': "Send /health to start a health query or /vaccine for vaccine info.",
        'first_question': "Please briefly describe your health problem.",
        'second_question': "What symptoms are you experiencing?",
        'third_question': "What is your age?",
        'fourth_question': "What is your gender?",
        'fifth_question': "How long have you had these symptoms?",
        'not_a_text': "Please enter text only.",
        'processing': "Processing your query, please wait...",
        'out_of_scope': "Sorry, your query seems outside the scope of health topics.",
        'api_error': "Sorry, there was an error processing your request.",
        'cancelled': "Conversation cancelled.",
        'disclaimer': "\n\n*Disclaimer: This is for informational purposes only and not a substitute for professional medical advice.*",
        'prompt_blocked': "Your query was blocked due to policy restrictions.",
        'language_name': "English",
        'vaccine_info_prompt': "Provide the latest information about vaccines.",
        'vaccine_age_prompt': "Please choose an age group for vaccination information:",
        'lang_not_supported': "This language is not fully supported yet. Falling back to English.",
    },
    'hi': {
        'welcome': "à¤†à¤¯à¥à¤°à¥à¤µà¥‡à¤¦ à¤®à¤¿à¤¤à¥à¤° à¤®à¥‡à¤‚ à¤†à¤ªà¤•à¤¾ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆ! à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¥€ à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥‡à¤‚:",
        'lang_chosen': "à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥€ à¤—à¤ˆ: à¤¹à¤¿à¤¨à¥à¤¦à¥€à¥¤ à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾ à¤•à¥‡ à¤²à¤¿à¤ /help à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¥‡à¤‚à¥¤",
        'help': "/health à¤¸à¥‡ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‡à¤‚ à¤¯à¤¾ /vaccine à¤¸à¥‡ à¤Ÿà¥€à¤•à¥‹à¤‚ à¤•à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¥‡à¤‚à¥¤",
        'first_question': "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¥€ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¤®à¤¸à¥à¤¯à¤¾ à¤¸à¤‚à¤•à¥à¤·à¥‡à¤ª à¤®à¥‡à¤‚ à¤¬à¤¤à¤¾à¤à¤‚à¥¤",
        'second_question': "à¤†à¤ªà¤®à¥‡à¤‚ à¤•à¥à¤¯à¤¾ à¤²à¤•à¥à¤·à¤£ à¤¹à¥ˆà¤‚?",
        'third_question': "à¤†à¤ªà¤•à¥€ à¤‰à¤®à¥à¤° à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?",
        'fourth_question': "à¤†à¤ªà¤•à¤¾ à¤²à¤¿à¤‚à¤— à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?",
        'fifth_question': "à¤¯à¤¹ à¤²à¤•à¥à¤·à¤£ à¤•à¤¬ à¤¸à¥‡ à¤¹à¥ˆà¤‚?",
        'not_a_text': "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤•à¥‡à¤µà¤² à¤Ÿà¥‡à¤•à¥à¤¸à¥à¤Ÿ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤",
        'processing': "à¤†à¤ªà¤•à¥‡ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤•à¥‹ à¤¸à¤‚à¤¸à¤¾à¤§à¤¿à¤¤ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ, à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤°à¤¤à¥€à¤•à¥à¤·à¤¾ à¤•à¤°à¥‡à¤‚...",
        'out_of_scope': "à¤•à¥à¤·à¤®à¤¾ à¤•à¤°à¥‡à¤‚, à¤†à¤ªà¤•à¤¾ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤µà¤¿à¤·à¤¯à¥‹à¤‚ à¤•à¥‡ à¤¬à¤¾à¤¹à¤° à¤¹à¥ˆà¥¤",
        'api_error': "à¤•à¥à¤·à¤®à¤¾ à¤•à¤°à¥‡à¤‚, à¤†à¤ªà¤•à¥‡ à¤…à¤¨à¥à¤°à¥‹à¤§ à¤•à¥‹ à¤¸à¤‚à¤¸à¤¾à¤§à¤¿à¤¤ à¤•à¤°à¤¤à¥‡ à¤¸à¤®à¤¯ à¤¤à¥à¤°à¥à¤Ÿà¤¿ à¤¹à¥à¤ˆà¥¤",
        'cancelled': "à¤¸à¤‚à¤µà¤¾à¤¦ à¤°à¤¦à¥à¤¦ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾à¥¤",
        'disclaimer': "\n\n*à¤…à¤¸à¥à¤µà¥€à¤•à¤°à¤£: à¤¯à¤¹ à¤•à¥‡à¤µà¤² à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤¹à¥ˆ à¤”à¤° à¤ªà¥‡à¤¶à¥‡à¤µà¤° à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¸à¤²à¤¾à¤¹ à¤•à¤¾ à¤µà¤¿à¤•à¤²à¥à¤ª à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤*",
        'prompt_blocked': "à¤¨à¥€à¤¤à¤¿ à¤ªà¥à¤°à¤¤à¤¿à¤¬à¤‚à¤§à¥‹à¤‚ à¤•à¥‡ à¤•à¤¾à¤°à¤£ à¤†à¤ªà¤•à¤¾ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤…à¤µà¤°à¥à¤¦à¥à¤§ à¤•à¤° à¤¦à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾ à¤¥à¤¾à¥¤",
        'language_name': "Hindi",
        'vaccine_info_prompt': "à¤Ÿà¥€à¤•à¥‹à¤‚ à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤¨à¤µà¥€à¤¨à¤¤à¤® à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤ªà¥à¤°à¤¦à¤¾à¤¨ à¤•à¤°à¥‡à¤‚à¥¤",
        'vaccine_age_prompt': "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤Ÿà¥€à¤•à¤¾à¤•à¤°à¤£ à¤•à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤†à¤¯à¥ à¤µà¤°à¥à¤— à¤šà¥à¤¨à¥‡à¤‚:",
        'lang_not_supported': "à¤¯à¤¹ à¤­à¤¾à¤·à¤¾ à¤…à¤­à¥€ à¤ªà¥‚à¤°à¥€ à¤¤à¤°à¤¹ à¤¸à¥‡ à¤¸à¤®à¤°à¥à¤¥à¤¿à¤¤ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤ à¤…à¤‚à¤—à¥à¤°à¥‡à¤œà¤¼à¥€ à¤®à¥‡à¤‚ à¤²à¥Œà¤Ÿ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚à¥¤",
    },
    # Add other languages similarly...
    'ta': {
        'welcome': "à®†à®°à¯‹à®•à¯à®•à®¿à®¯ à®®à®¿à®¤à¯à®°à®¾à®µà¯à®•à¯à®•à¯ à®µà®°à®µà¯‡à®±à¯à®•à®¿à®±à¯‹à®®à¯! à®‰à®™à¯à®•à®³à¯ à®®à¯Šà®´à®¿à®¯à¯ˆà®¤à¯ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®µà¯à®®à¯:",
        'lang_chosen': "à®®à¯Šà®´à®¿ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯: à®¤à®®à®¿à®´à¯. à®‰à®¤à®µà®¿à®•à¯à®•à¯ /help à®à®ªà¯ à®ªà®¯à®©à¯à®ªà®Ÿà¯à®¤à¯à®¤à®µà¯à®®à¯.",
        'help': "à®šà¯à®•à®¾à®¤à®¾à®°à®•à¯ à®•à¯‡à®³à¯à®µà®¿à®¯à¯ˆà®¤à¯ à®¤à¯Šà®Ÿà®™à¯à®• /health à® à®…à®©à¯à®ªà¯à®ªà®µà¯à®®à¯ à®…à®²à¯à®²à®¤à¯ à®¤à®Ÿà¯à®ªà¯à®ªà¯‚à®šà®¿ à®¤à®•à®µà®²à¯à®•à¯à®•à¯ /vaccine à® à®…à®©à¯à®ªà¯à®ªà®µà¯à®®à¯.",
        'vaccine_age_prompt': "à®¤à®Ÿà¯à®ªà¯à®ªà¯‚à®šà®¿ à®¤à®•à®µà®²à¯à®•à¯à®•à¯ à®’à®°à¯ à®µà®¯à®¤à¯ à®µà®°à®®à¯à®ªà¯ˆà®¤à¯ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®µà¯à®®à¯:",
        'disclaimer': "\n\n*à®®à®±à¯à®ªà¯à®ªà¯: à®‡à®¤à¯ à®¤à®•à®µà®²à¯ à®¨à¯‹à®•à¯à®•à®™à¯à®•à®³à¯à®•à¯à®•à®¾à®• à®®à®Ÿà¯à®Ÿà¯à®®à¯‡ à®®à®±à¯à®±à¯à®®à¯ à®¨à®¿à®ªà¯à®£à®¤à¯à®¤à¯à®µ à®®à®°à¯à®¤à¯à®¤à¯à®µ à®†à®²à¯‹à®šà®©à¯ˆà®•à¯à®•à¯ à®®à®¾à®±à¯à®±à®¾à®• à®…à®²à¯à®².*",
        'language_name': "Tamil",
    },
    'kn': {
        'welcome': "à²†à²°à³‹à²—à³à²¯ à²®à²¿à²¤à³à²°à²—à³† à²¸à³à²¸à³à²µà²¾à²—à²¤! à²¦à²¯à²µà²¿à²Ÿà³à²Ÿà³ à²¨à²¿à²®à³à²® à²­à²¾à²·à³†à²¯à²¨à³à²¨à³ à²†à²¯à³à²•à³†à²®à²¾à²¡à²¿:",
        'lang_chosen': "à²­à²¾à²·à³† à²†à²¯à³à²•à³†à²®à²¾à²¡à²²à²¾à²—à²¿à²¦à³†: à²•à²¨à³à²¨à²¡. à²¸à²¹à²¾à²¯à²•à³à²•à²¾à²—à²¿ /help à²…à²¨à³à²¨à³ à²¬à²³à²¸à²¿.",
        'help': "à²†à²°à³‹à²—à³à²¯ à²ªà³à²°à²¶à³à²¨à³†à²¯à²¨à³à²¨à³ à²ªà³à²°à²¾à²°à²‚à²­à²¿à²¸à²²à³ /health à²•à²³à³à²¹à²¿à²¸à²¿ à²…à²¥à²µà²¾ à²²à²¸à²¿à²•à³† à²®à²¾à²¹à²¿à²¤à²¿à²—à²¾à²—à²¿ /vaccine à²•à²³à³à²¹à²¿à²¸à²¿.",
        'vaccine_age_prompt': "à²²à²¸à²¿à²•à³† à²®à²¾à²¹à²¿à²¤à²¿à²—à²¾à²—à²¿ à²¦à²¯à²µà²¿à²Ÿà³à²Ÿà³ à²µà²¯à²¸à³à²¸à²¿à²¨ à²—à³à²‚à²ªà²¨à³à²¨à³ à²†à²¯à³à²•à³†à²®à²¾à²¡à²¿:",
        'disclaimer': "\n\n*à²¹à²•à³à²•à³à²¤à³à²¯à²¾à²—: à²‡à²¦à³ à²•à³‡à²µà²² à²®à²¾à²¹à²¿à²¤à²¿à²—à²¾à²—à²¿ à²®à²¾à²¤à³à²° à²®à²¤à³à²¤à³ à²µà³ƒà²¤à³à²¤à²¿à²ªà²° à²µà³ˆà²¦à³à²¯à²•à³€à²¯ à²¸à²²à²¹à³†à²—à³† à²¬à²¦à²²à²¿à²¯à²¾à²—à²¿à²²à³à²².*",
        'language_name': "Kannada",
    }
}

# --- Vaccination data ---
VACCINE_DATA = {
    'en': {
        '0_2': "Vaccination schedule for children aged 0-2 years:\n\n* **At Birth:** BCG, Hepatitis B (1st dose), Oral Polio Vaccine (OPV 0)\n* **6 Weeks:** DTaP, IPV, Hib, Hep B, PCV, Rotavirus\n* **10 Weeks:** DTaP, IPV, Hib, Hep B, Rotavirus\n* **14 Weeks:** DTaP, IPV, Hib, Hep B, PCV, Rotavirus\n* **9-12 Months:** Measles, Mumps, Rubella (MMR 1), Typhoid Conjugate Vaccine (TCV)\n* **16-24 Months:** DTaP booster, Polio booster, Measles, Mumps, Rubella (MMR 2), JE (if in endemic area)",
        '2_12': "Vaccination schedule for children aged 2-12 years:\n\n* **4-6 Years:** DTaP booster, Polio booster\n* **10 Years:** Tdap (Tetanus, Diphtheria, Pertussis) booster",
        '12_18': "Vaccination schedule for adolescents aged 12-18 years:\n\n* **11-12 Years:** Tdap, Human Papillomavirus (HPV) (2-3 doses), Meningococcal vaccine",
        'adult': "Vaccination schedule for adults:\n\n* **Tdap** (Tetanus, Diphtheria, Pertussis) booster every 10 years\n* **Seasonal Influenza** (Flu) vaccine annually\n* **Pneumococcal vaccine** (for at-risk individuals and those over 65)\n* **Hepatitis A and B vaccines** (for at-risk individuals)",
        'campaign': "Latest information on ongoing vaccination campaigns will be updated here based on public health advisories. Please check official government health websites for the most current information.",
    },
    'hi': {
        '0_2': "0-2 à¤µà¤°à¥à¤· à¤•à¥‡ à¤¬à¤šà¥à¤šà¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥€à¤•à¤¾à¤•à¤°à¤£ à¤…à¤¨à¥à¤¸à¥‚à¤šà¥€:\n\n* **à¤œà¤¨à¥à¤® à¤•à¥‡ à¤¸à¤®à¤¯:** à¤¬à¥€à¤¸à¥€à¤œà¥€, à¤¹à¥‡à¤ªà¥‡à¤Ÿà¤¾à¤‡à¤Ÿà¤¿à¤¸ à¤¬à¥€ (à¤ªà¤¹à¤²à¥€ à¤–à¥à¤°à¤¾à¤•), à¤“à¤°à¤² à¤ªà¥‹à¤²à¤¿à¤¯à¥‹ à¤µà¥ˆà¤•à¥à¤¸à¥€à¤¨ (à¤“à¤ªà¥€à¤µà¥€ 0)\n* **6 à¤¸à¤ªà¥à¤¤à¤¾à¤¹:** à¤¡à¥€à¤Ÿà¥€à¤à¤ªà¥€, à¤†à¤ˆà¤ªà¥€à¤µà¥€, à¤à¤šà¤†à¤ˆà¤¬à¥€, à¤¹à¥‡à¤ª à¤¬à¥€, à¤ªà¥€à¤¸à¥€à¤µà¥€, à¤°à¥‹à¤Ÿà¤¾à¤µà¤¾à¤¯à¤°à¤¸\n* **10 à¤¸à¤ªà¥à¤¤à¤¾à¤¹:** à¤¡à¥€à¤Ÿà¥€à¤à¤ªà¥€, à¤†à¤ˆà¤ªà¥€à¤µà¥€, à¤à¤šà¤†à¤ˆà¤¬à¥€, à¤¹à¥‡à¤ª à¤¬à¥€, à¤°à¥‹à¤Ÿà¤¾à¤µà¤¾à¤¯à¤°à¤¸\n* **14 à¤¸à¤ªà¥à¤¤à¤¾à¤¹:** à¤¡à¥€à¤Ÿà¥€à¤à¤ªà¥€, à¤†à¤ˆà¤ªà¥€à¤µà¥€, à¤à¤šà¤†à¤ˆà¤¬à¥€, à¤¹à¥‡à¤ª à¤¬à¥€, à¤ªà¥€à¤¸à¥€à¤µà¥€, à¤°à¥‹à¤Ÿà¤¾à¤µà¤¾à¤¯à¤°à¤¸\n* **9-12 à¤®à¤¹à¥€à¤¨à¥‡:** à¤–à¤¸à¤°à¤¾, à¤—à¤²à¤¸à¥à¤†, à¤°à¥‚à¤¬à¥‡à¤²à¤¾ (à¤à¤®à¤à¤®à¤†à¤° 1), à¤Ÿà¤¾à¤‡à¤«à¤¾à¤‡à¤¡ à¤¸à¤‚à¤¯à¥à¤—à¥à¤®à¤¿à¤¤ à¤µà¥ˆà¤•à¥à¤¸à¥€à¤¨ (à¤Ÿà¥€à¤¸à¥€à¤µà¥€)\n* **16-24 à¤®à¤¹à¥€à¤¨à¥‡:** à¤¡à¥€à¤Ÿà¥€à¤à¤ªà¥€ à¤¬à¥‚à¤¸à¥à¤Ÿà¤°, à¤ªà¥‹à¤²à¤¿à¤¯à¥‹ à¤¬à¥‚à¤¸à¥à¤Ÿà¤°, à¤–à¤¸à¤°à¤¾, à¤—à¤²à¤¸à¥à¤†, à¤°à¥‚à¤¬à¥‡à¤²à¤¾ (à¤à¤®à¤à¤®à¤†à¤° 2), à¤œà¥‡à¤ˆ (à¤¯à¤¦à¤¿ à¤¸à¥à¤¥à¤¾à¤¨à¤¿à¤• à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤®à¥‡à¤‚ à¤¹à¥ˆ)",
        '2_12': "2-12 à¤µà¤°à¥à¤· à¤•à¥‡ à¤¬à¤šà¥à¤šà¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥€à¤•à¤¾à¤•à¤°à¤£ à¤…à¤¨à¥à¤¸à¥‚à¤šà¥€:\n\n* **4-6 à¤µà¤°à¥à¤·:** à¤¡à¥€à¤Ÿà¥€à¤à¤ªà¥€ à¤¬à¥‚à¤¸à¥à¤Ÿà¤°, à¤ªà¥‹à¤²à¤¿à¤¯à¥‹ à¤¬à¥‚à¤¸à¥à¤Ÿà¤°\n* **10 à¤µà¤°à¥à¤·:** à¤Ÿà¥€à¤¡à¥€à¤à¤ªà¥€ (à¤Ÿà¤¿à¤Ÿà¤¨à¥‡à¤¸, à¤¡à¤¿à¤ªà¥à¤¥à¥€à¤°à¤¿à¤¯à¤¾, à¤ªà¤°à¥à¤Ÿà¥à¤¸à¤¿à¤¸) à¤¬à¥‚à¤¸à¥à¤Ÿà¤°",
        '12_18': "12-18 à¤µà¤°à¥à¤· à¤•à¥‡ à¤•à¤¿à¤¶à¥‹à¤°à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥€à¤•à¤¾à¤•à¤°à¤£ à¤…à¤¨à¥à¤¸à¥‚à¤šà¥€:\n\n* **11-12 à¤µà¤°à¥à¤·:** à¤Ÿà¥€à¤¡à¥€à¤à¤ªà¥€, à¤¹à¥à¤¯à¥‚à¤®à¤¨ à¤ªà¥ˆà¤ªà¤¿à¤²à¥‹à¤®à¤¾à¤µà¤¾à¤¯à¤°à¤¸ (à¤à¤šà¤ªà¥€à¤µà¥€) (2-3 à¤–à¥à¤°à¤¾à¤•), à¤®à¥‡à¤¨à¤¿à¤‚à¤—à¥‹à¤•à¥‹à¤•à¤² à¤µà¥ˆà¤•à¥à¤¸à¥€à¤¨",
        'adult': "à¤µà¤¯à¤¸à¥à¤•à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥€à¤•à¤¾à¤•à¤°à¤£ à¤…à¤¨à¥à¤¸à¥‚à¤šà¥€:\n\n* **à¤¹à¤° 10 à¤¸à¤¾à¤² à¤®à¥‡à¤‚ à¤Ÿà¥€à¤¡à¥€à¤à¤ªà¥€** (à¤Ÿà¤¿à¤Ÿà¤¨à¥‡à¤¸, à¤¡à¤¿à¤ªà¥à¤¥à¥€à¤°à¤¿à¤¯à¤¾, à¤ªà¤°à¥à¤Ÿà¥à¤¸à¤¿à¤¸) à¤¬à¥‚à¤¸à¥à¤Ÿà¤°\n* **à¤®à¥Œà¤¸à¤®à¥€ à¤‡à¤¨à¥à¤«à¥à¤²à¥‚à¤à¤‚à¤œà¤¾** (à¤«à¥à¤²à¥‚) à¤µà¥ˆà¤•à¥à¤¸à¥€à¤¨ à¤¸à¤¾à¤²à¤¾à¤¨à¤¾\n* **à¤¨à¥à¤¯à¥‚à¤®à¥‹à¤•à¥‹à¤•à¤² à¤µà¥ˆà¤•à¥à¤¸à¥€à¤¨** (à¤œà¥‹à¤–à¤¿à¤® à¤µà¤¾à¤²à¥‡ à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤¯à¥‹à¤‚ à¤”à¤° 65 à¤¸à¥‡ à¤…à¤§à¤¿à¤• à¤‰à¤®à¥à¤° à¤µà¤¾à¤²à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤)\n* **à¤¹à¥‡à¤ªà¥‡à¤Ÿà¤¾à¤‡à¤Ÿà¤¿à¤¸ à¤ à¤”à¤° à¤¬à¥€ à¤Ÿà¥€à¤•à¥‡** (à¤œà¥‹à¤–à¤¿à¤® à¤µà¤¾à¤²à¥‡ à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤¯à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤)",
        'campaign': "à¤šà¤² à¤°à¤¹à¥‡ à¤Ÿà¥€à¤•à¤¾à¤•à¤°à¤£ à¤…à¤­à¤¿à¤¯à¤¾à¤¨à¥‹à¤‚ à¤•à¥€ à¤¨à¤µà¥€à¤¨à¤¤à¤® à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¯à¤¹à¤¾à¤‚ à¤¸à¤¾à¤°à¥à¤µà¤œà¤¨à¤¿à¤• à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¤²à¤¾à¤¹ à¤•à¥‡ à¤†à¤§à¤¾à¤° à¤ªà¤° à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¥€ à¤œà¤¾à¤à¤—à¥€à¥¤ à¤¸à¤¬à¤¸à¥‡ à¤…à¤¦à¥à¤¯à¤¤à¤¨ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤†à¤§à¤¿à¤•à¤¾à¤°à¤¿à¤• à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤µà¥‡à¤¬à¤¸à¤¾à¤‡à¤Ÿà¥‹à¤‚ à¤•à¥€ à¤œà¤¾à¤‚à¤š à¤•à¤°à¥‡à¤‚à¥¤",
    }
}

def get_user_lang(context: ContextTypes.DEFAULT_TYPE) -> str:
    return context.user_data.get('lang', 'en')

# --- Handlers ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    keyboard = [
        [InlineKeyboardButton("English", callback_data='lang_en')],
        [InlineKeyboardButton("à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)", callback_data='lang_hi')],
        [InlineKeyboardButton("à®¤à®®à®¿à®´à¯ (Tamil)", callback_data='lang_ta')],
        [InlineKeyboardButton("à²•à²¨à³à²¨à²¡ (Kannada)", callback_data='lang_kn')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(MESSAGES['en']['welcome'], reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    lang_code = query.data.split('_')[1]
    
    # Set the language code
    context.user_data['lang'] = lang_code
    
    # Get the language-specific message, or fallback to English
    lang_chosen_msg = MESSAGES.get(lang_code, {}).get('lang_chosen', MESSAGES['en']['lang_chosen'])
    
    # Check if a message for the chosen language exists in the messages dict
    if lang_code not in MESSAGES or 'lang_chosen' not in MESSAGES[lang_code]:
        await query.edit_message_text(text=MESSAGES['en']['lang_not_supported'])
    else:
        await query.edit_message_text(text=lang_chosen_msg)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    lang = get_user_lang(context)
    help_msg = MESSAGES.get(lang, {}).get('help', MESSAGES['en']['help'])
    await update.message.reply_text(help_msg)

async def vaccine_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    keyboard = [
        [InlineKeyboardButton("0-2 years", callback_data='vaccine_0_2')],
        [InlineKeyboardButton("2-12 years", callback_data='vaccine_2_12')],
        [InlineKeyboardButton("12-18 years", callback_data='vaccine_12_18')],
        [InlineKeyboardButton("Adults", callback_data='vaccine_adult')],
        [InlineKeyboardButton("Ongoing campaigns", callback_data='vaccine_campaign')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    vaccine_age_prompt = MESSAGES.get(lang, {}).get('vaccine_age_prompt', MESSAGES['en']['vaccine_age_prompt'])
    await update.message.reply_text(vaccine_age_prompt, reply_markup=reply_markup)
    return VACCINE_AGE_GROUP

async def handle_vaccine_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    lang = get_user_lang(context)
    age_group_key = query.data.split('_')[1]
    
    vaccine_info = VACCINE_DATA.get(lang, {}).get(age_group_key, "Sorry, no information found for this age group.")
    
    disclaimer_msg = MESSAGES.get(lang, {}).get('disclaimer', MESSAGES['en']['disclaimer'])
    full_response = escape_markdown(vaccine_info, version=2) + escape_markdown(disclaimer_msg, version=2)
    
    await query.edit_message_text(text=full_response, parse_mode='MarkdownV2')
    
    return ConversationHandler.END


async def health_query_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    first_question = MESSAGES.get(lang, {}).get('first_question', MESSAGES['en']['first_question'])
    await update.message.reply_text(first_question)
    return PROBLEM

async def get_symptoms(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['problem'] = update.message.text
        second_question = MESSAGES.get(lang, {}).get('second_question', MESSAGES['en']['second_question'])
        await update.message.reply_text(second_question)
        return SYMPTOMS
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return PROBLEM

async def get_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['symptoms'] = update.message.text
        third_question = MESSAGES.get(lang, {}).get('third_question', MESSAGES['en']['third_question'])
        await update.message.reply_text(third_question)
        return AGE
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return SYMPTOMS

async def get_gender(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['age'] = update.message.text
        fourth_question = MESSAGES.get(lang, {}).get('fourth_question', MESSAGES['en']['fourth_question'])
        await update.message.reply_text(fourth_question)
        return GENDER
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return AGE

async def get_duration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['gender'] = update.message.text
        fifth_question = MESSAGES.get(lang, {}).get('fifth_question', MESSAGES['en']['fifth_question'])
        await update.message.reply_text(fifth_question)
        return DURATION
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return GENDER

async def final_response(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['duration'] = update.message.text
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return DURATION

    processing_msg = MESSAGES.get(lang, {}).get('processing', MESSAGES['en']['processing'])
    await update.message.reply_text(processing_msg)
    await update.message.chat.send_action(ChatAction.TYPING)

    problem = context.user_data.get('problem')
    symptoms = context.user_data.get('symptoms')
    age = context.user_data.get('age')
    gender = context.user_data.get('gender')
    duration = context.user_data.get('duration')

    full_query = (f"A user, age {age}, gender {gender}, is experiencing the following health problem: {problem}. "
                    f"The symptoms are: {symptoms}. These symptoms have been present for {duration}. "
                    "Provide a detailed and helpful response to this query.")

    try:
        # First classify if this is a health query
        classifier_model = genai.GenerativeModel('gemini-1.5-flash-latest')
        classification_prompt = (
            f"Is the following query related to health, diseases, symptoms, or medical awareness? "
            f"Answer only with 'YES' or 'NO'. Query: '{full_query}'"
        )
        classification_response = await classifier_model.generate_content_async(classification_prompt)

        if 'YES' not in classification_response.text.upper():
            out_of_scope_msg = MESSAGES.get(lang, {}).get('out_of_scope', MESSAGES['en']['out_of_scope'])
            await update.message.reply_text(out_of_scope_msg)
            return ConversationHandler.END

        # Generate health assistant answer
        language_name = MESSAGES.get(lang, {}).get('language_name', MESSAGES['en']['language_name'])
        model = genai.GenerativeModel(
            model_name='gemini-1.5-flash-latest',
            system_instruction=(
                f"You are Arogya Mitra, a helpful medical assistant. Your purpose is to provide "
                f"clear, educational information about health. When asked about a disease, provide its name, "
                f"common symptoms, general treatment or management advice, and clear guidance on when to see a doctor. "
                f"Your entire response must be in the {language_name} language."
            )
        )
        response = await model.generate_content_async(full_query)

        if response.parts:
            gemini_response = response.text
            escaped_response = escape_markdown(gemini_response, version=2)
            disclaimer_msg = MESSAGES.get(lang, {}).get('disclaimer', MESSAGES['en']['disclaimer'])
            full_response = escaped_response + escape_markdown(disclaimer_msg, version=2)
        else:
            if response.prompt_feedback and response.prompt_feedback.block_reason:
                logger.warning(f"Prompt blocked for user {update.effective_user.id}. Reason: {response.prompt_feedback.block_reason}")
                prompt_blocked_msg = MESSAGES.get(lang, {}).get('prompt_blocked', MESSAGES['en']['prompt_blocked'])
                full_response = escape_markdown(prompt_blocked_msg, version=2)
            else:
                api_error_msg = MESSAGES.get(lang, {}).get('api_error', MESSAGES['en']['api_error'])
                full_response = escape_markdown(api_error_msg, version=2)

        await update.message.reply_text(full_response, parse_mode='MarkdownV2')

        # Send feedback buttons after answer
        keyboard = [
            [
                InlineKeyboardButton("ðŸ˜Š", callback_data="feedback_happy"),
                InlineKeyboardButton("ðŸ˜", callback_data="feedback_neutral"),
                InlineKeyboardButton("ðŸ˜ž", callback_data="feedback_sad"),
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("How do you feel about this response?", reply_markup=reply_markup)

    except Exception as e:
        logger.error(f"Error in final_response: {e}")
        api_error_msg = MESSAGES.get(lang, {}).get('api_error', MESSAGES['en']['api_error'])
        await update.message.reply_text(api_error_msg)

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    cancelled_msg = MESSAGES.get(lang, {}).get('cancelled', MESSAGES['en']['cancelled'])
    await update.message.reply_text(cancelled_msg)
    return ConversationHandler.END

async def handle_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    
    feedback_type = query.data.split("_")[1]
    user_id = update.effective_user.id
    user_name = update.effective_user.full_name

    if feedback_type == "happy":
        message = "ðŸ˜Š Thank you! We're glad you found it helpful!"
    elif feedback_type == "neutral":
        message = "ðŸ˜ Thank you for your feedback!"
    elif feedback_type == "sad":
        message = "ðŸ˜ž We're sorry to hear that. We'll keep improving."
    else:
        message = "Thank you for your feedback!"

    # Log feedback in terminal
    print(f"[FEEDBACK] User: {user_name} (ID: {user_id}) gave feedback: {feedback_type.upper()}")

    # Edit message to show thank you message
    await query.edit_message_text(message)

# --- Main function ---

def main() -> None:
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    conv_health_handler = ConversationHandler(
        entry_points=[CommandHandler("health", health_query_start)],
        states={
            PROBLEM: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_symptoms)],
            SYMPTOMS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_age)],
            AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_gender)],
            GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_duration)],
            DURATION: [MessageHandler(filters.TEXT & ~filters.COMMAND, final_response)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    conv_vaccine_handler = ConversationHandler(
        entry_points=[CommandHandler("vaccine", vaccine_start)],
        states={
            VACCINE_AGE_GROUP: [CallbackQueryHandler(handle_vaccine_age, pattern="^vaccine_")],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler, pattern="^lang_"))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(conv_health_handler)
    application.add_handler(conv_vaccine_handler)
    application.add_handler(CallbackQueryHandler(handle_feedback, pattern="^feedback_"))

    application.run_polling()

if __name__ == "__main__":
    main()
