import os
import logging
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ChatAction
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    CallbackQueryHandler,
    ConversationHandler,
)
from telegram.helpers import escape_markdown
import google.generativeai as genai
from dotenv import load_dotenv

# Firebase (optional, only if you have credentials)
import firebase_admin
from firebase_admin import credentials, firestore

# Load .env if you have one
# load_dotenv()

# --- Logging setup ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logging.getLogger("httpx").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# --- Configuration ---
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "8476487980:AAGA0KPOkDnTr5sKqN7VSDke7A7bW9xPHAE")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "AIzaSyAylJS6nqUEzCM1AUBjeYB68YVhLuLQeTg")
FIREBASE_CREDENTIALS_PATH = os.getenv("FIREBASE_CREDENTIALS_PATH")

if not TELEGRAM_BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN is not set!")
if not GEMINI_API_KEY:
    raise ValueError("GEMINI_API_KEY is not set!")

db = None
if FIREBASE_CREDENTIALS_PATH:
    try:
        cred = credentials.Certificate(FIREBASE_CREDENTIALS_PATH)
        firebase_admin.initialize_app(cred)
        db = firestore.client()
        logger.info("Firebase initialized successfully.")
    except Exception as e:
        logger.error(f"Firebase init failed: {e}")

# Configure Gemini API
genai.configure(api_key=GEMINI_API_KEY)

# --- Conversation States ---
PROBLEM, SYMPTOMS, AGE, GENDER, DURATION, VACCINE_AGE_GROUP = range(6)

# --- Localization messages ---
MESSAGES = {
    'en': {
        'welcome': "Welcome to Arogya Mitra! Please select your language:",
        'lang_chosen': "Language selected: English. Use /help for assistance.",
        'help': "Send /health to start a health query or /vaccine for vaccine info.",
        'first_question': "Please briefly describe your health problem.",
        'second_question': "What symptoms are you experiencing?",
        'third_question': "What is your age?",
        'fourth_question': "What is your gender?",
        'fifth_question': "How long have you had these symptoms?",
        'not_a_text': "Please enter text only.",
        'processing': "Processing your query, please wait...",
        'out_of_scope': "Sorry, your query seems outside the scope of health topics.",
        'api_error': "Sorry, there was an error processing your request.",
        'cancelled': "Conversation cancelled.",
        'disclaimer': "\n\n*Disclaimer: This is for informational purposes only and not a substitute for professional medical advice.*",
        'prompt_blocked': "Your query was blocked due to policy restrictions.",
        'language_name': "English",
        'vaccine_info_prompt': "Provide the latest information about vaccines.",
        'vaccine_age_prompt': "Please choose an age group for vaccination information:",
        'lang_not_supported': "This language is not fully supported yet. Falling back to English.",
    },
    'hi': {
        'welcome': "आयुर्वेद मित्र में आपका स्वागत है! कृपया अपनी भाषा चुनें:",
        'lang_chosen': "भाषा चुनी गई: हिन्दी। सहायता के लिए /help का उपयोग करें।",
        'help': "/health से स्वास्थ्य प्रश्न शुरू करें या /vaccine से टीकों की जानकारी प्राप्त करें।",
        'first_question': "कृपया अपनी स्वास्थ्य समस्या संक्षेप में बताएं।",
        'second_question': "आपमें क्या लक्षण हैं?",
        'third_question': "आपकी उम्र क्या है?",
        'fourth_question': "आपका लिंग क्या है?",
        'fifth_question': "यह लक्षण कब से हैं?",
        'not_a_text': "कृपया केवल टेक्स्ट दर्ज करें।",
        'processing': "आपके प्रश्न को संसाधित किया जा रहा है, कृपया प्रतीक्षा करें...",
        'out_of_scope': "क्षमा करें, आपका प्रश्न स्वास्थ्य विषयों के बाहर है।",
        'api_error': "क्षमा करें, आपके अनुरोध को संसाधित करते समय त्रुटि हुई।",
        'cancelled': "संवाद रद्द किया गया।",
        'disclaimer': "\n\n*अस्वीकरण: यह केवल जानकारी के लिए है और पेशेवर चिकित्सा सलाह का विकल्प नहीं है।*",
        'prompt_blocked': "नीति प्रतिबंधों के कारण आपका प्रश्न अवरुद्ध कर दिया गया था।",
        'language_name': "Hindi",
        'vaccine_info_prompt': "टीकों के बारे में नवीनतम जानकारी प्रदान करें।",
        'vaccine_age_prompt': "कृपया टीकाकरण की जानकारी के लिए एक आयु वर्ग चुनें:",
        'lang_not_supported': "यह भाषा अभी पूरी तरह से समर्थित नहीं है। अंग्रेज़ी में लौट रहे हैं।",
    },
    # Add other languages similarly...
    'ta': {
        'welcome': "ஆரோக்கிய மித்ராவுக்கு வரவேற்கிறோம்! உங்கள் மொழியைத் தேர்ந்தெடுக்கவும்:",
        'lang_chosen': "மொழி தேர்ந்தெடுக்கப்பட்டது: தமிழ். உதவிக்கு /help ஐப் பயன்படுத்தவும்.",
        'help': "சுகாதாரக் கேள்வியைத் தொடங்க /health ஐ அனுப்பவும் அல்லது தடுப்பூசி தகவலுக்கு /vaccine ஐ அனுப்பவும்.",
        'vaccine_age_prompt': "தடுப்பூசி தகவலுக்கு ஒரு வயது வரம்பைத் தேர்ந்தெடுக்கவும்:",
        'disclaimer': "\n\n*மறுப்பு: இது தகவல் நோக்கங்களுக்காக மட்டுமே மற்றும் நிபுணத்துவ மருத்துவ ஆலோசனைக்கு மாற்றாக அல்ல.*",
        'language_name': "Tamil",
    },
    'kn': {
        'welcome': "ಆರೋಗ್ಯ ಮಿತ್ರಗೆ ಸುಸ್ವಾಗತ! ದಯವಿಟ್ಟು ನಿಮ್ಮ ಭಾಷೆಯನ್ನು ಆಯ್ಕೆಮಾಡಿ:",
        'lang_chosen': "ಭಾಷೆ ಆಯ್ಕೆಮಾಡಲಾಗಿದೆ: ಕನ್ನಡ. ಸಹಾಯಕ್ಕಾಗಿ /help ಅನ್ನು ಬಳಸಿ.",
        'help': "ಆರೋಗ್ಯ ಪ್ರಶ್ನೆಯನ್ನು ಪ್ರಾರಂಭಿಸಲು /health ಕಳುಹಿಸಿ ಅಥವಾ ಲಸಿಕೆ ಮಾಹಿತಿಗಾಗಿ /vaccine ಕಳುಹಿಸಿ.",
        'vaccine_age_prompt': "ಲಸಿಕೆ ಮಾಹಿತಿಗಾಗಿ ದಯವಿಟ್ಟು ವಯಸ್ಸಿನ ಗುಂಪನ್ನು ಆಯ್ಕೆಮಾಡಿ:",
        'disclaimer': "\n\n*ಹಕ್ಕುತ್ಯಾಗ: ಇದು ಕೇವಲ ಮಾಹಿತಿಗಾಗಿ ಮಾತ್ರ ಮತ್ತು ವೃತ್ತಿಪರ ವೈದ್ಯಕೀಯ ಸಲಹೆಗೆ ಬದಲಿಯಾಗಿಲ್ಲ.*",
        'language_name': "Kannada",
    }
}

# --- Vaccination data ---
VACCINE_DATA = {
    'en': {
        '0_2': "Vaccination schedule for children aged 0-2 years:\n\n* **At Birth:** BCG, Hepatitis B (1st dose), Oral Polio Vaccine (OPV 0)\n* **6 Weeks:** DTaP, IPV, Hib, Hep B, PCV, Rotavirus\n* **10 Weeks:** DTaP, IPV, Hib, Hep B, Rotavirus\n* **14 Weeks:** DTaP, IPV, Hib, Hep B, PCV, Rotavirus\n* **9-12 Months:** Measles, Mumps, Rubella (MMR 1), Typhoid Conjugate Vaccine (TCV)\n* **16-24 Months:** DTaP booster, Polio booster, Measles, Mumps, Rubella (MMR 2), JE (if in endemic area)",
        '2_12': "Vaccination schedule for children aged 2-12 years:\n\n* **4-6 Years:** DTaP booster, Polio booster\n* **10 Years:** Tdap (Tetanus, Diphtheria, Pertussis) booster",
        '12_18': "Vaccination schedule for adolescents aged 12-18 years:\n\n* **11-12 Years:** Tdap, Human Papillomavirus (HPV) (2-3 doses), Meningococcal vaccine",
        'adult': "Vaccination schedule for adults:\n\n* **Tdap** (Tetanus, Diphtheria, Pertussis) booster every 10 years\n* **Seasonal Influenza** (Flu) vaccine annually\n* **Pneumococcal vaccine** (for at-risk individuals and those over 65)\n* **Hepatitis A and B vaccines** (for at-risk individuals)",
        'campaign': "Latest information on ongoing vaccination campaigns will be updated here based on public health advisories. Please check official government health websites for the most current information.",
    },
    'hi': {
        '0_2': "0-2 वर्ष के बच्चों के लिए टीकाकरण अनुसूची:\n\n* **जन्म के समय:** बीसीजी, हेपेटाइटिस बी (पहली खुराक), ओरल पोलियो वैक्सीन (ओपीवी 0)\n* **6 सप्ताह:** डीटीएपी, आईपीवी, एचआईबी, हेप बी, पीसीवी, रोटावायरस\n* **10 सप्ताह:** डीटीएपी, आईपीवी, एचआईबी, हेप बी, रोटावायरस\n* **14 सप्ताह:** डीटीएपी, आईपीवी, एचआईबी, हेप बी, पीसीवी, रोटावायरस\n* **9-12 महीने:** खसरा, गलसुआ, रूबेला (एमएमआर 1), टाइफाइड संयुग्मित वैक्सीन (टीसीवी)\n* **16-24 महीने:** डीटीएपी बूस्टर, पोलियो बूस्टर, खसरा, गलसुआ, रूबेला (एमएमआर 2), जेई (यदि स्थानिक क्षेत्र में है)",
        '2_12': "2-12 वर्ष के बच्चों के लिए टीकाकरण अनुसूची:\n\n* **4-6 वर्ष:** डीटीएपी बूस्टर, पोलियो बूस्टर\n* **10 वर्ष:** टीडीएपी (टिटनेस, डिप्थीरिया, पर्टुसिस) बूस्टर",
        '12_18': "12-18 वर्ष के किशोरों के लिए टीकाकरण अनुसूची:\n\n* **11-12 वर्ष:** टीडीएपी, ह्यूमन पैपिलोमावायरस (एचपीवी) (2-3 खुराक), मेनिंगोकोकल वैक्सीन",
        'adult': "वयस्कों के लिए टीकाकरण अनुसूची:\n\n* **हर 10 साल में टीडीएपी** (टिटनेस, डिप्थीरिया, पर्टुसिस) बूस्टर\n* **मौसमी इन्फ्लूएंजा** (फ्लू) वैक्सीन सालाना\n* **न्यूमोकोकल वैक्सीन** (जोखिम वाले व्यक्तियों और 65 से अधिक उम्र वालों के लिए)\n* **हेपेटाइटिस ए और बी टीके** (जोखिम वाले व्यक्तियों के लिए)",
        'campaign': "चल रहे टीकाकरण अभियानों की नवीनतम जानकारी यहां सार्वजनिक स्वास्थ्य सलाह के आधार पर अपडेट की जाएगी। सबसे अद्यतन जानकारी के लिए कृपया आधिकारिक सरकारी स्वास्थ्य वेबसाइटों की जांच करें।",
    }
}

def get_user_lang(context: ContextTypes.DEFAULT_TYPE) -> str:
    return context.user_data.get('lang', 'en')

# --- Handlers ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    keyboard = [
        [InlineKeyboardButton("English", callback_data='lang_en')],
        [InlineKeyboardButton("हिन्दी (Hindi)", callback_data='lang_hi')],
        [InlineKeyboardButton("தமிழ் (Tamil)", callback_data='lang_ta')],
        [InlineKeyboardButton("ಕನ್ನಡ (Kannada)", callback_data='lang_kn')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(MESSAGES['en']['welcome'], reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    lang_code = query.data.split('_')[1]
    
    # Set the language code
    context.user_data['lang'] = lang_code
    
    # Get the language-specific message, or fallback to English
    lang_chosen_msg = MESSAGES.get(lang_code, {}).get('lang_chosen', MESSAGES['en']['lang_chosen'])
    
    # Check if a message for the chosen language exists in the messages dict
    if lang_code not in MESSAGES or 'lang_chosen' not in MESSAGES[lang_code]:
        await query.edit_message_text(text=MESSAGES['en']['lang_not_supported'])
    else:
        await query.edit_message_text(text=lang_chosen_msg)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    lang = get_user_lang(context)
    help_msg = MESSAGES.get(lang, {}).get('help', MESSAGES['en']['help'])
    await update.message.reply_text(help_msg)

async def vaccine_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    keyboard = [
        [InlineKeyboardButton("0-2 years", callback_data='vaccine_0_2')],
        [InlineKeyboardButton("2-12 years", callback_data='vaccine_2_12')],
        [InlineKeyboardButton("12-18 years", callback_data='vaccine_12_18')],
        [InlineKeyboardButton("Adults", callback_data='vaccine_adult')],
        [InlineKeyboardButton("Ongoing campaigns", callback_data='vaccine_campaign')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    vaccine_age_prompt = MESSAGES.get(lang, {}).get('vaccine_age_prompt', MESSAGES['en']['vaccine_age_prompt'])
    await update.message.reply_text(vaccine_age_prompt, reply_markup=reply_markup)
    return VACCINE_AGE_GROUP

async def handle_vaccine_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    lang = get_user_lang(context)
    age_group_key = query.data.split('_')[1]
    
    vaccine_info = VACCINE_DATA.get(lang, {}).get(age_group_key, "Sorry, no information found for this age group.")
    
    disclaimer_msg = MESSAGES.get(lang, {}).get('disclaimer', MESSAGES['en']['disclaimer'])
    full_response = escape_markdown(vaccine_info, version=2) + escape_markdown(disclaimer_msg, version=2)
    
    await query.edit_message_text(text=full_response, parse_mode='MarkdownV2')
    
    return ConversationHandler.END


async def health_query_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    first_question = MESSAGES.get(lang, {}).get('first_question', MESSAGES['en']['first_question'])
    await update.message.reply_text(first_question)
    return PROBLEM

async def get_symptoms(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['problem'] = update.message.text
        second_question = MESSAGES.get(lang, {}).get('second_question', MESSAGES['en']['second_question'])
        await update.message.reply_text(second_question)
        return SYMPTOMS
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return PROBLEM

async def get_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['symptoms'] = update.message.text
        third_question = MESSAGES.get(lang, {}).get('third_question', MESSAGES['en']['third_question'])
        await update.message.reply_text(third_question)
        return AGE
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return SYMPTOMS

async def get_gender(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['age'] = update.message.text
        fourth_question = MESSAGES.get(lang, {}).get('fourth_question', MESSAGES['en']['fourth_question'])
        await update.message.reply_text(fourth_question)
        return GENDER
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return AGE

async def get_duration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['gender'] = update.message.text
        fifth_question = MESSAGES.get(lang, {}).get('fifth_question', MESSAGES['en']['fifth_question'])
        await update.message.reply_text(fifth_question)
        return DURATION
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return GENDER

async def final_response(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    if update.message and update.message.text:
        context.user_data['duration'] = update.message.text
    else:
        not_a_text = MESSAGES.get(lang, {}).get('not_a_text', MESSAGES['en']['not_a_text'])
        await update.message.reply_text(not_a_text)
        return DURATION

    processing_msg = MESSAGES.get(lang, {}).get('processing', MESSAGES['en']['processing'])
    await update.message.reply_text(processing_msg)
    await update.message.chat.send_action(ChatAction.TYPING)

    problem = context.user_data.get('problem')
    symptoms = context.user_data.get('symptoms')
    age = context.user_data.get('age')
    gender = context.user_data.get('gender')
    duration = context.user_data.get('duration')

    full_query = (f"A user, age {age}, gender {gender}, is experiencing the following health problem: {problem}. "
                    f"The symptoms are: {symptoms}. These symptoms have been present for {duration}. "
                    "Provide a detailed and helpful response to this query.")

    try:
        # First classify if this is a health query
        classifier_model = genai.GenerativeModel('gemini-1.5-flash-latest')
        classification_prompt = (
            f"Is the following query related to health, diseases, symptoms, or medical awareness? "
            f"Answer only with 'YES' or 'NO'. Query: '{full_query}'"
        )
        classification_response = await classifier_model.generate_content_async(classification_prompt)

        if 'YES' not in classification_response.text.upper():
            out_of_scope_msg = MESSAGES.get(lang, {}).get('out_of_scope', MESSAGES['en']['out_of_scope'])
            await update.message.reply_text(out_of_scope_msg)
            return ConversationHandler.END

        # Generate health assistant answer
        language_name = MESSAGES.get(lang, {}).get('language_name', MESSAGES['en']['language_name'])
        model = genai.GenerativeModel(
            model_name='gemini-1.5-flash-latest',
            system_instruction=(
                f"You are Arogya Mitra, a helpful medical assistant. Your purpose is to provide "
                f"clear, educational information about health. When asked about a disease, provide its name, "
                f"common symptoms, general treatment or management advice, and clear guidance on when to see a doctor. "
                f"Your entire response must be in the {language_name} language."
            )
        )
        response = await model.generate_content_async(full_query)

        if response.parts:
            gemini_response = response.text
            escaped_response = escape_markdown(gemini_response, version=2)
            disclaimer_msg = MESSAGES.get(lang, {}).get('disclaimer', MESSAGES['en']['disclaimer'])
            full_response = escaped_response + escape_markdown(disclaimer_msg, version=2)
        else:
            if response.prompt_feedback and response.prompt_feedback.block_reason:
                logger.warning(f"Prompt blocked for user {update.effective_user.id}. Reason: {response.prompt_feedback.block_reason}")
                prompt_blocked_msg = MESSAGES.get(lang, {}).get('prompt_blocked', MESSAGES['en']['prompt_blocked'])
                full_response = escape_markdown(prompt_blocked_msg, version=2)
            else:
                api_error_msg = MESSAGES.get(lang, {}).get('api_error', MESSAGES['en']['api_error'])
                full_response = escape_markdown(api_error_msg, version=2)

        await update.message.reply_text(full_response, parse_mode='MarkdownV2')

        # Send feedback buttons after answer
        keyboard = [
            [
                InlineKeyboardButton("😊", callback_data="feedback_happy"),
                InlineKeyboardButton("😐", callback_data="feedback_neutral"),
                InlineKeyboardButton("😞", callback_data="feedback_sad"),
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("How do you feel about this response?", reply_markup=reply_markup)

    except Exception as e:
        logger.error(f"Error in final_response: {e}")
        api_error_msg = MESSAGES.get(lang, {}).get('api_error', MESSAGES['en']['api_error'])
        await update.message.reply_text(api_error_msg)

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    lang = get_user_lang(context)
    cancelled_msg = MESSAGES.get(lang, {}).get('cancelled', MESSAGES['en']['cancelled'])
    await update.message.reply_text(cancelled_msg)
    return ConversationHandler.END

async def handle_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    
    feedback_type = query.data.split("_")[1]
    user_id = update.effective_user.id
    user_name = update.effective_user.full_name

    if feedback_type == "happy":
        message = "😊 Thank you! We're glad you found it helpful!"
    elif feedback_type == "neutral":
        message = "😐 Thank you for your feedback!"
    elif feedback_type == "sad":
        message = "😞 We're sorry to hear that. We'll keep improving."
    else:
        message = "Thank you for your feedback!"

    # Log feedback in terminal
    print(f"[FEEDBACK] User: {user_name} (ID: {user_id}) gave feedback: {feedback_type.upper()}")

    # Edit message to show thank you message
    await query.edit_message_text(message)

# --- Main function ---

def main() -> None:
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    conv_health_handler = ConversationHandler(
        entry_points=[CommandHandler("health", health_query_start)],
        states={
            PROBLEM: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_symptoms)],
            SYMPTOMS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_age)],
            AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_gender)],
            GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_duration)],
            DURATION: [MessageHandler(filters.TEXT & ~filters.COMMAND, final_response)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    conv_vaccine_handler = ConversationHandler(
        entry_points=[CommandHandler("vaccine", vaccine_start)],
        states={
            VACCINE_AGE_GROUP: [CallbackQueryHandler(handle_vaccine_age, pattern="^vaccine_")],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler, pattern="^lang_"))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(conv_health_handler)
    application.add_handler(conv_vaccine_handler)
    application.add_handler(CallbackQueryHandler(handle_feedback, pattern="^feedback_"))

    application.run_polling()

if __name__ == "__main__":
    main()
